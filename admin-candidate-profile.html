<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aday Profili | Dijital Usta</title>
  <link rel="stylesheet" href="./s/site.css" />
  <link rel="icon" type="image/x-icon" href="./s/favicon.ico" />
</head>

<body>
  <header>
    <a href="./"><img src="./s/logo.png" alt="Dijital Usta" /></a>
    <button aria-label="Menü"><i></i><i></i><i></i></button>
  </header>
  <nav>
    <ul></ul>
  </nav>
  <main>
    <h2><span id="displayName"></span></h2>

    <details open>
      <summary>Kişisel Bilgiler</summary>
      <div>

        <label for="image">
          <img id="image" />
        </label>

        <label>Email
          <span id="email"></span>
        </label>

        <label>Telefon
          <span id="phone"></span>
        </label>

        <label>Doğum Tarihi
          <span id="birthDate"></span>
        </label>

        <label>Cinsiyet
          <span id="gender"></span>
        </label>

        <label>Aday İli
          <span id="city"></span>
        </label>

        <label>Aday İlçesi
          <span id="county"></span>
        </label>

      </div>
    </details>

    <details open>
      <summary>Eğitim Bilgileri</summary>
      <div>

        <label>Eğitim Durumu
          <span id="educationLevel"></span>
        </label>

        <label>Üniversite Adı
          <span id="university"></span>
        </label>

        <label>Bölümü
          <span id="major"></span>
        </label>

        <label>Sınıfı
          <span id="classYear"></span>
        </label>

        <label>Yabancı Diller
          <span id="languages"></span>
        </label>
      </div>
    </details>

    <details open>
      <summary>Kariyer Bilgileri</summary>
      <div>

        <label>Motivasyon Mektubu
          <textarea readonly id="motivationLetter"></textarea>
        </label>

        <label>Deneyimler
          <table class="load">
            <thead>
              <tr>
                <th id="companyName">Önceki Çalıştığı Firma</th>
                <th id="start">Başlangıç Tarihi</th>
                <th id="end">Bitiş Tarihi</th>
                <th id="position">Pozisyon</th>
                <th id="description">Açıklama</th>
              </tr>
            </thead>
            <tbody id="CandidateExperience"></tbody>
          </table>
        </label>

        <label>Sertifikalar
          <table class="load">
            <thead>
              <tr>
                <th id="name">Sertifika</th>
                <th id="company">Veren Kurum</th>
                <th id="year">Alındığı Yıl</th>
                <th id="description">Açıklama</th>
              </tr>
            </thead>
            <tbody id="CandidateCertificate"></tbody>
          </table>
        </label>
      </div>
    </details>

    <details open>
      <summary>Aday İşlem Geçmişi ve Durumu</summary>
      <div>

        <label for="status">
          Durum
          <span id="status"></span>
        </label>

        <label for="pointOnlineExam">
          Online Sınav Puanı
          <span id="pointOnlineExam"></span>
        </label>

        <label for="pointA">
          Başarı Puanı A
          <span id="pointA"></span>
        </label>

        <label for="pointTobb">
          TOBB ETÜ Puanı
          <span id="pointTobb"></span>
        </label>

        <label for="pointB">
          Başarı Puanı B
          <span id="pointB"></span>
        </label>

        <table class="load">
          <thead>
            <tr>
              <th id="actingMemberName">İşlemi Yapan</th>
              <th id="companyName" data-url="admin-company-profile.html?id={companyId}">Firma</th>
              <th id="action">İşlem</th>
              <th id="createdAt">Zaman</th>
            </tr>
          </thead>
          <tbody id="CandidateHistory"></tbody>
        </table>

        <a href="admin-candidate-survey.html" class="qs">Anket Bilgileri</a>
      </div>
    </details>

    <details open>
      <summary>Yapay Zeka İşlemleri</summary>

      <div>
        <label>Yapay Zeka Değerlendirmesi Onaylandı mı?
          <span id="aiApproved">Hayır</span>
        </label>

        <label>Yapay Zeka Değerlendirme Puanı
          <span id="aiScore"></span>
        </label>

        <label style="grid-column: span 3;">Yapay Zeka Değerlendirme Açıklaması
          <span id="aiEvaluation"></span>
        </label>

        <div>
          <button id="btnAIApprove" style="margin-bottom: 8px;">AI Değerlendirmesini Onayla</button>
          <p id="msgAIApprove"></p>

          <button id="btnAIReview">Tekrar AI ile Değerlendir</button>
          <p id="msgAIReview"></p>
        </div>
      </div>

    </details>

    <details open>
      <summary>Kısa Listeye Ekleyen Firmalar</summary>
      <div>

        <div>
          <label class="sel">
            <input type="text" id="companySearch" placeholder="Adayın izin verdiği firma adı yazın..."
              autocomplete="off" />
          </label>

          <input type="hidden" id="selectedCompanyId" />
          <button id="addShortlistBtn" disabled>Kısa Listeye Ekle</button>
          <p id="shortlistMsg"></p>
        </div>

        <table class="load">
          <thead>
            <tr>
              <th id="companyName" data-url="admin-company-profile.html?id={companyId}">Firma</th>
              <th id="city">İl</th>
              <th id="trendyolUrl" data-url="trendyolUrl">Trendyol Satıcı Profili</th>
              <th id="webUrl" data-url="webUrl">Web Sitesi</th>
              <th id="createdAt">Zaman</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="CandidateShortlisted"></tbody>
        </table>
      </div>
    </details>

    <details>
      <summary>Adayın Profilini Görüntüleyebilme İzni Alan Firmalar</summary>
      <div>
        <input type="text" class="tblfilter" placeholder="filtrele" />
        <table class="load">
          <thead>
            <tr>
              <th id="companyName" data-url="admin-company-profile.html?id={companyId}">Firma</th>
              <th id="city">İl</th>
              <th id="trendyolUrl" data-url="trendyolUrl">Trendyol Satıcı Profili</th>
              <th id="webUrl" data-url="webUrl">Web Sitesi</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="CandidateCompany"></tbody>
        </table>
      </div>
    </details>

    <a href="candidate-profile-edit.html" class="qs">Profili Güncelle</a>
  </main>
  <footer>
    <div>
      <span>
        <h1>Dijital Usta</h1>
        <p>Gençleri e-ticaretle buluşturup<br />KOBİ'lere yetkin iş gücü kazandırmayı amaçlar.</p>
      </span>
      <img src="./s/logo-3.png" alt="Dijital Usta'nın Destekçileri" />
    </div>
    <div>
      © 2025 Dijital Usta | Tüm Haklar Saklıdır.
      <a href="concent.html">KVKK Aydınlatma Metni ve Açık Rıza Formu</a>
    </div>
  </footer>
  <script src="./s/site.js"></script>
  <script>
    let candidateId;
    let companies = [];
    let companiesLoaded = false;

    let $shortlistTbody = document.getElementById("CandidateShortlisted");
    if ($shortlistTbody) {
      $shortlistTbody.addEventListener("tableLoaded", (e) => {
        let data = e.detail.data;
        if (!data || data.length === 0) { return; }

        let candidateName = document.getElementById("displayName")?.textContent;

        let rows = e.target.querySelectorAll("tr");
        rows.forEach((tr, index) => {
          let item = data[index];
          if (item && item.companyId && candidateId) {
            let $msg = p();
            let $hireBtn = createHireApproveButton(candidateId, item.companyId, candidateName, item.isInterviewResulted, item.isInterviewSuccess, item.isHired);
            let $interviewBtn = createInterviewReportButton(candidateId, item.companyId, candidateName, true, $hireBtn, item.isInterviewResulted, item.isHired);
            let $shortlistBtn = createShortlistButton(candidateId, item.companyId, candidateName, true, $msg, $interviewBtn, item.isInterviewResulted, item.isHired);
            $interviewBtn.$shortlistBtn = $shortlistBtn;
            tr.lastElementChild.append(
              $shortlistBtn,
              $interviewBtn,
              $hireBtn,
              $msg
            );
          }
        });
      });
    }

    let $historyTbody = document.getElementById("CandidateHistory");
    if ($historyTbody) {
      $historyTbody.addEventListener("tableLoaded", (e) => {
        let data = e.detail.data;
        if (!data || data.length === 0) { return; }

        let rows = e.target.querySelectorAll("tr");
        rows.forEach((tr, index) => {
          let item = data[index];
          if (item) {
            let companyNameCell = tr.querySelector("td:nth-child(2)");
            if (companyNameCell) {
              let link = companyNameCell.querySelector("a");
              if (link && link.textContent === "Admin") {
                link.outerHTML = link.textContent;
              }
            }
          }
        });
      });
    }

    onAuthReady(async () => {
      candidateId = await fillSpans("Candidate/Get");

      let $letter = document.getElementById("motivationLetter");
      if ($letter.value === "-") {
        $letter.value = "Motivasyon mektubu bulunmamaktadır.";
        $letter.style.height = "auto";
      }

      let $btnAIApprove = document.getElementById("btnAIApprove");
      let $msgAIApprove = document.getElementById("msgAIApprove");
      let $aiApprovedSpan = document.getElementById("aiApproved");

      if ($btnAIApprove && $aiApprovedSpan) {
        let isApproved = $aiApprovedSpan.textContent.trim() === "Evet";
        $btnAIApprove.innerText = isApproved ? "AI Değerlendirmesi Onayını Geri Al" : "AI Değerlendirmesini Onayla";

        $btnAIApprove.addEventListener(CLICK_EVENT, async function () {
          let isCurrentlyApproved = $aiApprovedSpan.textContent.trim() === "Evet";
          let endpoint = isCurrentlyApproved ? "AI/Unapprove" : "AI/Approve";
          let confirmMessage = isCurrentlyApproved
            ? "AI değerlendirmesi onayını geri almak istediğinize emin misiniz?"
            : "AI değerlendirmesini onaylamak istediğinize emin misiniz?";

          let $mbody = div();
          let $confirmLabel = p(confirmMessage);
          let $msgDiv = div(CSS_CLASSES.modalMessage);
          let $modal;

          let handleApprove = async function () {
            setButtonLoading(buttons.submitBtn, true);
            setMessageText($msgAIApprove, LOADING_MESSAGE_WAIT);

            let result = await api(endpoint, { memberId: candidateId });

            if (result && result.isSuccess) {
              isCurrentlyApproved = !isCurrentlyApproved;
              $aiApprovedSpan.textContent = isCurrentlyApproved ? "Evet" : "Hayır";
              $btnAIApprove.innerText = isCurrentlyApproved ? "AI Değerlendirmesi Onayını Geri Al" : "AI Değerlendirmesini Onayla";
              setMessageText($msgAIApprove, "");
              closeModal($modal);
            } else {
              setMessageText($msgAIApprove, ERROR_MESSAGE_DEFAULT);
              showModalMessage($msgDiv, "error", ERROR_MESSAGE_DEFAULT);
              setButtonLoading(buttons.submitBtn, false);
            }
          };

          let buttons = createModalButtons(
            "İptal",
            isCurrentlyApproved ? "Onayı Geri Al" : "Onayla",
            () => closeModal($modal),
            handleApprove
          );

          $mbody.append($confirmLabel, buttons.buttonsDiv, $msgDiv);
          $modal = createModal("Onay", $mbody);
        });
      }

      let $btnAIReview = document.getElementById("btnAIReview");
      let $msgAIReview = document.getElementById("msgAIReview");
      let $aiScoreSpan = document.getElementById("aiScore");
      let $aiEvaluationTextarea = document.getElementById("aiEvaluation");

      if ($btnAIReview) {
        $btnAIReview.addEventListener(CLICK_EVENT, async function () {
          let $mbody = div();

          let $aiLabel = lbl("AI Seçimi");
          $aiLabel.className = "sel";
          let $aiInput = inp();
          $aiInput.placeholder = "AI seçiniz...";
          $aiInput.value = "Google Gemini";
          $aiInput.required = true;
          $aiInput.readOnly = true;
          let $aiList = div();
          $aiList.id = "aiList";
          $aiLabel.append($aiInput, $aiList);

          let selectedAI = $aiInput.value;
          let aiOptions = [$aiInput.value, "Open AI chatGPT"];

          $aiInput.addEventListener(CLICK_EVENT, function () {
            if ($aiList.children.length === 0) {
              aiOptions.forEach(ai => {
                let $item = div();
                $item.textContent = ai;
                $item.addEventListener(CLICK_EVENT, function (e) {
                  e.stopPropagation();
                  e.preventDefault();
                  $aiInput.value = ai;
                  selectedAI = ai;
                  $aiList.classList.remove("show");
                });
                $aiList.appendChild($item);
              });
            }
            $aiList.classList.toggle("show");
          });

          let $promptLabel = lbl("AI Prompt");
          let $promptInput = txt();
          $promptInput.placeholder = "Standart promptu özelleştirmek isterseniz yazın";
          $promptInput.rows = 5;
          $promptLabel.append($promptInput);

          let $msgDiv = div(CSS_CLASSES.modalMessage);
          let $modal;

          let handleEvaluate = async function () {
            if (!selectedAI) {
              showModalMessage($msgDiv, "error", "AI seçimi yapınız.");
              return;
            }

            let promptValue = $promptInput.value.trim();

            setButtonLoading(buttons.submitBtn, true);
            setMessageText($msgAIReview, LOADING_MESSAGE_WAIT);

            let result = await api("AI/Evaluate", {
              memberId: candidateId,
              aiName: selectedAI,
              prompt: promptValue
            });

            if (result && result.isSuccess) {
              if (result.data) {
                if ($aiScoreSpan && result.data.aiScore !== undefined) {
                  $aiScoreSpan.textContent = result.data.aiScore;
                }
                if ($aiEvaluationTextarea && result.data.aiEvaluation !== undefined) {
                  $aiEvaluationTextarea.value = result.data.aiEvaluation;
                }
              }

              setMessageText($msgAIReview, "");
              showSuccessAndClose($msgDiv, $modal, "AI değerlendirmesi tamamlandı.");
            } else {
              setMessageText($msgAIReview, ERROR_MESSAGE_DEFAULT);
              showModalMessage($msgDiv, "error", result?.message || ERROR_MESSAGE_DEFAULT);
              setButtonLoading(buttons.submitBtn, false);
            }
          };

          let buttons = createModalButtons(
            "İptal",
            "Değerlendirt",
            () => closeModal($modal),
            handleEvaluate
          );

          $mbody.append($aiLabel, $promptLabel, buttons.buttonsDiv, $msgDiv);
          $modal = createModal("Tekrar AI ile Değerlendir", $mbody);
        });
      }

      if (document.getElementById("status") && document.getElementById("status").textContent === "İşe alım doğrulandı") {
        $shortlistTbody.closest("details").remove();
      }
      else {
        let $search = document.getElementById("companySearch");
        let $selectedId = document.getElementById("selectedCompanyId");
        let $addBtn = document.getElementById("addShortlistBtn");
        let $msg = document.getElementById("shortlistMsg");

        autocomplete(
          $search,
          async () => {
            if (!companiesLoaded) {
              let companyResult = await api("CandidateCompany/GetAll", { memberId: candidateId });
              if (companyResult && companyResult.isSuccess) {
                companies = companyResult.data;
                companiesLoaded = true;
              }
            }
            return companies;
          },
          (company, searchText) => company.companyName.toLowerCase().includes(searchText.toLowerCase()),
          (company) => `${company.companyName} (${company.city})`,
          (company, $input) => {
            $input.value = company.companyName;
            $selectedId.value = company.companyId;
            $addBtn.disabled = false;
          }
        );

        $addBtn.addEventListener(CLICK_EVENT, async function () {
          let companyId = $selectedId.value;
          if (!companyId || !candidateId) {
            $msg.innerText = "Bir firma seçiniz.";
            return;
          }

          $msg.textContent = "";
          let result = await apiBtn(this, "CompanyShortlist/Add", {
            memberId: candidateId,
            companyId: companyId
          }, "Kısa listeye eklendi", ERROR_MESSAGE_DEFAULT);

          if (result && result.isSuccess) {
            $search.value = "";
            $selectedId.value = "";
            $addBtn.disabled = true;

            await loadTables("#" + $shortlistTbody.id);
          }
        });
      }

      await loadTables();
      setFilters();
    });
  </script>
</body>

</html>
