<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aday Profili Güncelle | Dijital Usta</title>
  <link rel="stylesheet" href="site.css" />
</head>

<body>
  <header>
    <h1><a href="./">Dijital Usta</a></h1>
  </header>
  <menu></menu>
  <div class="slogan">Gençleri e-ticaretle buluşturup KOBİ’lere yetkin iş gücü kazandırmayı amaçlar.</div>
  <main>
    <div id="msg"></div>
    <h2>Aday Profili Güncelle</h2>

    <label>Adı Soyadı
      <input type="text" id="displayName" />
    </label>

    <label>Doğum Tarihi
      <input type="date" id="birthDate" />
    </label>

    <label>Cinsiyet
      <input type="text" id="gender" />
    </label>

    <label>Eğitim Durumu
      <input type="text" id="educationLevel" />
    </label>

    <label class="sel">Üniversite Adı
      <input type="text" id="university" placeholder="Üniversite ara..." autocomplete="off" />
      <div id="universityList"></div>
    </label>

    <input type="text" id="customUniversity" placeholder="Üniversite adını manuel girin..." style="display: none; margin-top: 8px;" />

    <label>Bölümü
      <input type="text" id="major" />
    </label>

    <label>Sınıfı
      <input type="text" id="classYear" />
    </label>

    <label>Aday İli
      <input type="text" id="city" />
    </label>

    <label>Aday İlçesi
      <input type="text" id="county" />
    </label>

    <label>Seyahat Engeli Var Mı?
      <input type="text" id="travelWillingness" />
    </label>

    <label>Çalışmak İstediği Sektör
      <input type="text" id="willingSector" />
    </label>

    <button>Kaydet</button>
    <p></p>
  </main>
  <footer>© 2025 Dijital Usta | Tüm Haklar Saklıdır.</footer>
  <script src="site.js"></script>
  <script>
    let universities = [];
    let $university = document.getElementById("university");
    let $universityList = document.getElementById("universityList");

    // Üniversite listesini yükle
    async function loadUniversities() {
      let hashResult = await api("University/Hash", {});
      let currentHash = hashResult?.data || "";
      let storedHash = localStorage.getItem("universitiesHash");
      let storedUniversities = localStorage.getItem("universities");

      if (currentHash && storedHash === currentHash && storedUniversities) {
        // Local'den yükle
        universities = JSON.parse(storedUniversities);
      } else {
        // API'den yükle
        let result = await api("University/GetAll", {});
        if (result && result.isSuccess && Array.isArray(result.data)) {
          universities = result.data;
          localStorage.setItem("universities", JSON.stringify(universities));
          localStorage.setItem("universitiesHash", currentHash);
        }
      }
    }

    let $customUniversity = document.getElementById("customUniversity");

    // Üniversite listesini filtrele ve göster
    function filterUniversities(searchText) {
      $universityList.innerHTML = "";

      if (!searchText) {
        $universityList.classList.remove("show");
        return;
      }

      let filtered = universities.filter(u =>
        u.name.toLowerCase().includes(searchText.toLowerCase())
      );

      if (filtered.length === 0) {
        $universityList.classList.remove("show");
        return;
      }

      filtered.forEach(u => {
        let $item = document.createElement("div");
        $item.textContent = u.name;
        $item.addEventListener(CLICK_EVENT, function () {
          $university.value = u.name;
          $universityList.classList.remove("show");
          $customUniversity.style.display = "none";
          $customUniversity.value = "";
        });
        $universityList.appendChild($item);
      });

      // "Üniversitem listede yok" seçeneği ekle
      let $notInList = document.createElement("div");
      $notInList.textContent = "Üniversitem listede yok";
      $notInList.style.fontStyle = "italic";
      $notInList.style.color = "#666";
      $notInList.addEventListener(CLICK_EVENT, function () {
        $university.value = "";
        $universityList.classList.remove("show");
        $customUniversity.style.display = "block";
        $customUniversity.focus();
      });
      $universityList.appendChild($notInList);

      $universityList.classList.add("show");
    }

    // Input'a yazıldığında filtrele
    $university.addEventListener("input", function () {
      filterUniversities(this.value.trim());
    });

    // Input'a focus olduğunda listeyi göster
    $university.addEventListener("focus", function () {
      if (this.value.trim()) {
        filterUniversities(this.value.trim());
      }
    });

    // Dışarıya tıklandığında listeyi kapat
    document.addEventListener(CLICK_EVENT, function (e) {
      if (!e.target.closest(".sel")) {
        $universityList.classList.remove("show");
      }
    });

    onAuthReady(async () => {
      await loadUniversities();
      let id = await fillInputs("Candidate/Get");

      document.querySelector("button").addEventListener(CLICK_EVENT, async function () {
        // Custom university doluysa onu kullan, değilse normal university inputunu kullan
        let universityValue = $customUniversity.style.display === "block" && $customUniversity.value.trim()
          ? $customUniversity.value.trim()
          : val("university");

        let req = {
          memberId: id,
          displayName: val("displayName"),
          birthDate: val("birthDate"),
          gender: val("gender"),
          educationLevel: val("educationLevel"),
          university: universityValue,
          major: val("major"),
          classYear: val("classYear") || "",
          city: val("city"),
          county: val("county"),
          travelWillingness: val("travelWillingness"),
          willingSector: val("willingSector")
        };

        let errors = [];
        if (!req.displayName) { errors.push("Lütfen adınızı ve soyadınızı giriniz."); }
        if (!req.birthDate) { errors.push("Lütfen doğum tarihinizi giriniz."); }
        if (!req.gender) { errors.push("Lütfen cinsiyetinizi giriniz."); }
        if (!req.educationLevel) { errors.push("Lütfen eğitim durumunuzu giriniz."); }
        if (!req.university) { errors.push("Lütfen üniversite adını giriniz."); }
        if (!req.major) { errors.push("Lütfen bölüm bilgisini giriniz."); }
        if (!req.city) { errors.push("Lütfen il bilgisini giriniz."); }
        if (!req.county) { errors.push("Lütfen ilçe bilgisini giriniz."); }
        if (!req.travelWillingness) { errors.push("Lütfen seyahat engeli bilgisini giriniz."); }

        if (errors.length) {
          let p = this.nextElementSibling;
          p.innerHTML = errors.map(e => `• ${e}`).join("<br>");
          return;
        }

        await apiBtn(this, "Candidate/Update", req, "Güncelleme başarılı.", "Güncelleme başarısız oldu, lütfen tekrar deneyiniz.", "candidate-profile.html?id=" + id);
      });
    });
  </script>
</body>

</html>
