<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profil Fotoğrafı Güncelle | Dijital Usta</title>
  <link rel="stylesheet" href="site.css" />
</head>

<body>
  <header>
    <h1><a href="./">Dijital Usta</a></h1>
  </header>
  <menu></menu>
  <div class="slogan">Gençleri e-ticaretle buluşturup KOBİ'lere yetkin iş gücü kazandırmayı amaçlar.</div>
  <main>
    <div id="msg"></div>
    <h2>Profil Fotoğrafı Güncelle</h2>

    <div class="image-preview" id="imagePreview">
      Görsel yükleniyor...
    </div>

    <label>Profil Fotoğrafı
      <input type="file" id="fileInput" accept="image/jpeg,image/png,image/gif">
    </label>

    <button id="submitBtn" disabled>Güncelle</button>
    <p></p>
  </main>
  <footer>© 2025 Dijital Usta | Tüm Haklar Saklıdır.</footer>
  <script src="site.js"></script>
  <script>
    onReady(async () => {
      const fileInput = document.getElementById('fileInput');
      const imagePreview = document.getElementById('imagePreview');
      const submitBtn = document.getElementById('submitBtn');

      let base64String = null;
      let candidateId = new URLSearchParams(location.search).get('id');

      // Load current image
      try {
        const result = await api('Candidate/Image', { id: candidateId });
        if (result && result.image) {
          base64String = result.image;
          imagePreview.innerHTML = `<img src="${base64String}" alt="Profil Fotoğrafı">`;
        } else {
          imagePreview.innerHTML = 'Görsel yüklenmedi';
        }
      } catch (error) {
        imagePreview.innerHTML = 'Görsel yüklenemedi';
      }

      // File input change
      fileInput.addEventListener('change', (e) => {
        handleFile(e.target.files[0]);
      });

      // Submit button
      submitBtn.addEventListener('click', async function () {
        if (!base64String) {
          let p = this.nextElementSibling;
          p.innerHTML = '• Lütfen bir görsel seçin';
          return;
        }
        await uploadImage(this);
      });

      // Handle file selection
      function handleFile(file) {
        if (!file) return;

        // Validate file type
        const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
        if (!validTypes.includes(file.type)) {
          let p = submitBtn.nextElementSibling;
          p.innerHTML = '• Geçersiz dosya türü. Sadece JPG, PNG veya GIF yükleyebilirsiniz.';
          return;
        }

        // Validate file size (500KB max)
        const maxSize = 500 * 1024; // 500KB
        if (file.size > maxSize) {
          let p = submitBtn.nextElementSibling;
          p.innerHTML = '• Dosya boyutu çok büyük. Maksimum 500KB yükleyebilirsiniz.';
          return;
        }

        // Convert to base64 and preview
        convertToBase64(file);
      }

      // Convert file to base64
      function convertToBase64(file) {
        const reader = new FileReader();

        reader.onload = function (e) {
          base64String = e.target.result;

          // Update preview
          imagePreview.innerHTML = `<img src="${base64String}" alt="Preview">`;

          submitBtn.disabled = false;
          let p = submitBtn.nextElementSibling;
          p.innerHTML = '';
        };

        reader.onerror = function () {
          let p = submitBtn.nextElementSibling;
          p.innerHTML = '• Dosya okunurken bir hata oluştu';
        };

        reader.readAsDataURL(file);
      }

      // Upload image to server
      async function uploadImage(btn) {
        btn.disabled = true;
        let p = btn.nextElementSibling;
        p.innerHTML = 'Görsel yükleniyor, lütfen bekleyiniz...';

        try {
          const result = await api('Candidate/ImageChange', {
            id: candidateId,
            image: base64String
          });

          if (!result || result.error || !result.isSuccess) {
            p.innerText = 'Görsel güncellenemedi, lütfen tekrar deneyiniz.';
            btn.disabled = false;
          } else {
            p.innerText = 'Profil fotoğrafınız başarıyla güncellendi!';
            setTimeout(() => {
              location.href = 'candidate-profile.html?id=' + candidateId;
            }, 1500);
          }
        } catch (error) {
          console.error('Upload error:', error);
          p.innerText = 'Bir hata oluştu. Lütfen tekrar deneyin.';
          btn.disabled = false;
        }
      }
    });
  </script>
</body>

</html>
