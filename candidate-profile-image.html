<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profil Fotoğrafı Güncelle | Dijital Usta</title>
  <link rel="stylesheet" href="site.css" />
</head>

<body>
  <header>
    <h1><a href="./">Dijital Usta</a></h1>
  </header>
  <menu></menu>
  <div class="slogan">Gençleri e-ticaretle buluşturup KOBİ'lere yetkin iş gücü kazandırmayı amaçlar.</div>
  <main>
    <div id="msg"></div>
    <h2>Profil Fotoğrafı Güncelle</h2>

    <div class="image-preview" id="imagePreview">
      Görsel yükleniyor...
    </div>

    <label>Profil Fotoğrafı
      <input type="file" id="fileInput" accept="image/jpeg,image/png" />
    </label>

    <button id="submitBtn" disabled>Güncelle</button>
    <p></p>
  </main>
  <footer>© 2025 Dijital Usta | Tüm Haklar Saklıdır.</footer>
  <script src="site.js"></script>
  <script>
    onAuthReady(async () => {
      let fileInput = document.getElementById('fileInput');
      let imagePreview = document.getElementById('imagePreview');
      let submitBtn = document.getElementById('submitBtn');
      let base64String = null;

      try {
        let result = await api('Candidate/Image', { memberId: USER.id });
        if (result && result.image) {
          base64String = result.image;
          imagePreview.innerHTML = `<img src="${base64String}" alt="Profil Fotoğrafı">`;
        } else {
          imagePreview.innerHTML = 'Görsel yüklenmedi';
        }
      } catch (error) {
        imagePreview.innerHTML = 'Görsel yüklenemedi';
      }

      fileInput.addEventListener('change', (e) => { handleFile(e.target.files[0]); });

      submitBtn.addEventListener('click', async function () {
        if (!base64String) {
          let p = this.nextElementSibling;
          p.innerHTML = '• Lütfen bir görsel seçin';
          return;
        }
        await uploadImage(this);
      });

      function handleFile(file) {
        if (!file) return;

        let validTypes = ['image/jpeg', 'image/png', 'image/gif'];
        if (!validTypes.includes(file.type)) {
          let p = submitBtn.nextElementSibling;
          p.innerHTML = '• Geçersiz dosya türü. Sadece JPG, PNG veya GIF yükleyebilirsiniz.';
          return;
        }

        let maxSize = 500 * 1024; // 500KB
        if (file.size > maxSize) {
          let p = submitBtn.nextElementSibling;
          p.innerHTML = '• Dosya boyutu çok büyük. Maksimum 500KB yükleyebilirsiniz.';
          return;
        }

        let img = new Image();
        img.onload = function () {
          if (this.width < 150 || this.height < 150) {
            let p = submitBtn.nextElementSibling;
            p.innerHTML = '• Görsel boyutu çok küçük. Minimum 150x150 piksel olmalıdır.';
            return;
          }

          if (this.width > 1500 || this.height > 1500) {
            let p = submitBtn.nextElementSibling;
            p.innerHTML = '• Görsel boyutu çok büyük. Maksimum 1500x1500 piksel olmalıdır.';
            return;
          }
        };

        img.onerror = function () {
          let p = submitBtn.nextElementSibling;
          p.innerHTML = '• Görsel dosyası okunamadı.';
        };

        img.src = URL.createObjectURL(file);
        convertToBase64(file);
      }

      function convertToBase64(file) {
        let reader = new FileReader();

        reader.onload = function (e) {
          base64String = e.target.result;

          imagePreview.innerHTML = `<img src="${base64String}" alt="Preview">`;

          submitBtn.disabled = false;
          let p = submitBtn.nextElementSibling;
          p.innerHTML = '';
        };

        reader.onerror = function () {
          let p = submitBtn.nextElementSibling;
          p.innerHTML = '• Dosya okunurken bir hata oluştu';
        };

        reader.readAsDataURL(file);
      }

      async function uploadImage(btn) {
        btn.disabled = true;
        let p = btn.nextElementSibling;
        p.innerHTML = 'Görsel yükleniyor, lütfen bekleyiniz...';

        try {
          let result = await api('Candidate/ImageChange', {
            memberId: USER.id,
            imageBase64: base64String
          });

          if (!result || result.error || !result.isSuccess) {
            p.innerText = 'Görsel güncellenemedi, lütfen tekrar deneyiniz.';
            btn.disabled = false;
          } else {
            p.innerText = 'Profil fotoğrafınız başarıyla güncellendi!';
            setTimeout(() => { location.href = 'candidate-profile.html'; }, 1234);
          }
        } catch (error) {
          console.error('Upload error:', error);
          p.innerText = 'Bir hata oluştu. Lütfen tekrar deneyin.';
          btn.disabled = false;
        }
      }
    });
  </script>
</body>

</html>
